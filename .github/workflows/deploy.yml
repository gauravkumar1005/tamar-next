name: Deploy Next.js Static Site to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # 3️⃣ Install, Build & Export (IMPORTANT)
      - name: Build static site
        run: |
          npm ci
          NEXT_DISABLE_TURBOPACK=1 npm run build

      # 4️⃣ Upload build to EC2
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            set -e

            RELEASE_DIR=/var/www/releases/$(date +%Y%m%d%H%M%S)

            echo "➡️ Create release directory"
            sudo mkdir -p $RELEASE_DIR

            echo "➡️ Upload new static files"
            sudo rsync -av --delete ./out/ $RELEASE_DIR/

            echo "➡️ Switch symlink (zero downtime)"
            sudo ln -sfn $RELEASE_DIR /var/www/tamar-next

            echo "➡️ Fix permissions"
            sudo chown -R nginx:nginx $RELEASE_DIR
            sudo find $RELEASE_DIR -type d -exec chmod 755 {} \;
            sudo find $RELEASE_DIR -type f -exec chmod 644 {} \;

            echo "➡️ Reload nginx"
            sudo nginx -t
            sudo systemctl reload nginx

            echo "✅ DEPLOY SUCCESSFUL"
